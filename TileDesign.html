<html>
    <head>
        <title>Broken Tile Map Design</title>
        <!-- CSS only -->
        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css" integrity="sha384-9aIt2nRpC12Uk9gS9baDl411NQApFmC26EwAOH8WgZl5MYYxFfc+NcPb1dKGj7Sk" crossorigin="anonymous">

        <!-- JS, Popper.js, and jQuery -->
        <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"> </script>
        <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"> </script>
        <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js" integrity="sha384-OgVRvuATP1z7JjHLkuOU7Xw704+h835Lr+6QL9UvYjZE3Ipu6Tp75j7Bh/kR0JKI" crossorigin="anonymous"> </script>
        <script src="map.js"></script>
        <script src="tilesets.js"></script>
        <script>
            const dX = 70;
            const dY = 70;
            var sX = null;
            var sY = null;
            var tileSet = [];
            var map = null;
            var mapArray = [];
            var lastImg = null;

            function loadMap(m) {
                map = m;
                mapArray = [];
                for (var i = 0; i < map.length; i++) {
                    let square = map[i];
                    if (mapArray[square.x] == null) {
                        mapArray[square.x] = []
                    }
                    mapArray[square.x][square.y] = square;
                }
            }

            function setup() {
                loadTileSet();
                loadMap(defaultMap);
                render();
            }

            function getContext() {
                var c = document.getElementById("mapCanvas");
                var ctx = c.getContext("2d");
                ctx.lineWidth = 1;
                return ctx;
            }

            function drawSquare(ctx, x, y, img) {
                var oX = dX * x,
                    oY = dY * y;
                ctx.beginPath();
                if (document.getElementById("showRedGrid").checked) {
                    ctx.strokeStyle = "red";
                } else {
                    ctx.strokeStyle = "black";
                }
                if ((sX == x) && (sY == y)) {
                    ctx.strokeStyle = "blue";
                    ctx.fillStyle = "blue";
                } else {
                    ctx.fillStyle = "red";
                }
                try {
                    ctx.drawImage(tileSet[0], oX, oY, dX, dY)
                    if ((img != null) && (img.length > 0)) {
                        for (var c = 0; c < img.length; c++) {
                            let i = img[c];
                            try{
                                ctx.drawImage(tileSet[i], oX, oY, dX, dY)
                            } catch (e) {
                                //alert(e);
                            }
                        };
                    }
                } catch (e) {
                    //alert(e);
                }
                if (document.getElementById("showXY").checked) {
                    ctx.font = "10px Comic Sans MS";
                    ctx.textAlign = "left";
                    ctx.fillText("[" + x + "," + y + "]", oX, 10 + oY);
                }
                if (document.getElementById("showGrid").checked) {
                    ctx.strokeRect(oX, oY, dX, dY);
                }
                if ((sX == x) && (sY == y)) {
                    ctx.strokeRect(oX, oY, dX, dY);
                }
            }

            function render(sq) {
                var ctx = getContext();
                if (sq == null) {
                    for (var i = 0; i < map.length; i++) {
                        let square = map[i];
                        drawSquare(ctx, square.x, square.y, square.img);
                    }
                } else {
                    drawSquare(ctx, sq.x, sq.y, sq.img);
                }
            }

            function addToSquare(square, tile, bottom){
                if(bottom){
                    if((square.img.length!=0)&&(square.img[0]==tile)){
                    } else {
                        square.img.unshift(tile);
                    }
                } else {
                    if((square.img.length!=0)&&(square.img[square.img.length-1]==tile)){
                    } else {
                        square.img.push(tile);
                    }
                }
                render(square);
            }

            function canvasClick(event) {
                //var elem = document.getElementById('mapCanvas'), elemLeft = elem.offsetLeft, elemTop = elem.offsetTop, x = event.pageX - elemLeft, y = event.pageY - elemTop;
                let elem = document.getElementById('mapCanvas');
                let elemLeft = elem.offsetLeft,
                    elemTop = elem.offsetTop;
                let selemLeft = elem.parentNode.scrollLeft,
                    selemTop = elem.parentNode.scrollTop;
                let pelemLeft = elem.parentNode.offsetLeft,
                    pelemTop = elem.parentNode.offsetTop;
                let x = selemLeft + (event.pageX - (pelemLeft + elemLeft)),
                    y = selemTop + (event.pageY - (pelemTop + elemTop));
                oSX = sX;
                oSY = sY;
                sX = Math.floor(x / dX, 0);
                sY = Math.floor(y / dY, 0);
                if ((lastImg != null) && (event.ctrlKey == true)) {
                    addToSquare(mapArray[sX][sY], lastImg, event.shiftKey);
                }
                if ((lastImg != null) && (event.altKey == true)) {
                    if (oSX <= sX) {
                        for (var iX = oSX; iX <= sX; iX++) {
                            if (oSY <= sY) {
                                for (var iY = oSY; iY <= sY; iY++) {
                                    addToSquare(mapArray[iX][iY], lastImg, event.shiftKey);
                                }
                            } else {
                                for (var iY = sY; iY <= oSY; iY++) {
                                    addToSquare(mapArray[iX][iY], lastImg, event.shiftKey);
                                }
                            }
                        }
                    } else {
                        for (var iX = sX; iX <= oSX; iX++) {
                            if (oSY <= sY) {
                                for (var iY = oSY; iY <= sY; iY++) {
                                    addToSquare(mapArray[iX][iY], lastImg, event.shiftKey);
                                }
                            } else {
                                for (var iY = sY; iY <= oSY; iY++) {
                                    addToSquare(mapArray[iX][iY], lastImg, event.shiftKey);
                                }
                            }
                        }
                    }
                }
                displaySelectedInfo(mapArray[sX][sY]);
                if (oSX != null) {
                    render(mapArray[oSX][oSY]);
                }
                render(mapArray[sX][sY]);
            }

            function displaySelectedInfo(square) {
                document.getElementById('selectedCoordsDiv').innerHTML = "(" + square.x + ", " + square.y + ")"
                document.getElementById('selectedImgDiv').innerHTML = "";
                let imgText = "";
                square.img.forEach(function (i, c) {
                    let x = document.createElement("div")
                    try{
                        let z = tileSet[i].cloneNode(true);
                        z.setAttribute("onclick", "");
                        x.appendChild(z);
                    } catch (e){}

                    //imgText += '<img src="' + tileSet[i] +'" width="70" height="70" /> <br/>';
                    //z.setAttribute("onclick", "removeTile(" + square.x + ", " + square.y + ", " + c + ")");
                    const xsf = '<button onclick="removeTile(' + square.x + ', ' + square.y + ', ' + c + ')"><svg class="bi bi-x-square-fill" width="1em" height="1em" viewBox="0 0 16 16" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M2 0a2 2 0 00-2 2v12a2 2 0 002 2h12a2 2 0 002-2V2a2 2 0 00-2-2H2zm9.854 4.854a.5.5 0 00-.708-.708L8 7.293 4.854 4.146a.5.5 0 10-.708.708L7.293 8l-3.147 3.146a.5.5 0 00.708.708L8 8.707l3.146 3.147a.5.5 0 00.708-.708L8.707 8l3.147-3.146z" clip-rule="evenodd"/></svg></button>';
                    const dsf = '<button onclick="moveTile(' + square.x + ', ' + square.y + ', ' + c + ', true)"><svg class="bi bi-dash-square-fill" width="1em" height="1em" viewBox="0 0 16 16" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M2 0a2 2 0 00-2 2v12a2 2 0 002 2h12a2 2 0 002-2V2a2 2 0 00-2-2H2zm2 7.5a.5.5 0 000 1h8a.5.5 0 000-1H4z" clip-rule="evenodd"/></svg></button>';
                    const psf = '<button onclick="moveTile(' + square.x + ', ' + square.y + ', ' + c + ', false)"><svg class="bi bi-plus-square-fill" width="1em" height="1em" viewBox="0 0 16 16" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M2 0a2 2 0 00-2 2v12a2 2 0 002 2h12a2 2 0 002-2V2a2 2 0 00-2-2H2zm6.5 4a.5.5 0 00-1 0v3.5H4a.5.5 0 000 1h3.5V12a.5.5 0 001 0V8.5H12a.5.5 0 000-1H8.5V4z" clip-rule="evenodd"/></svg></button>';
                    x.innerHTML += xsf + dsf + psf;
                    document.getElementById('selectedImgDiv').appendChild(x);
                    //document.getElementById('selectedImgDiv').appendChild(document.createElement("BR"));

                });
                //document.getElementById('selectedImgDiv').innerHTML = imgText;

            }

            function imageSelectChanged() {
                if (sX != null) {
                    var v = document.getElementById('imageSelect').value;
                    mapArray[sX][sY].img = v;
                    lastImg = v;
                    render(mapArray[sX][sY]);
                }
            }

            function tilePicked(tile, event) {
                if (sX != null) {
                    addToSquare(mapArray[sX][sY], tile, event.shiftKey);
                    lastImg = tile;
                    render(mapArray[sX][sY]);
                    displaySelectedInfo(mapArray[sX][sY]);
                }
            }

            function removeTile(iX, iY, iZ) {
                //mapArray[iX][iY].img = 
                mapArray[iX][iY].img.splice(iZ, 1);
                render(mapArray[iX][iY]);
                displaySelectedInfo(mapArray[sX][sY]);
            }

            function moveTile(iX, iY, iZ, up){
                if(up){
                    if(iZ==0){
                        return;
                    } else {
                        let i1 = mapArray[iX][iY].img[iZ];
                        let i2 = mapArray[iX][iY].img[iZ-1];
                        mapArray[iX][iY].img[iZ] = i2;
                        mapArray[iX][iY].img[iZ-1] = i1;
                    }
                } else {
                    if(iZ==(mapArray[iX][iY].img.length-1)){
                        return;
                    } else {
                        let i1 = mapArray[iX][iY].img[iZ];
                        let i2 = mapArray[iX][iY].img[iZ+1];
                        mapArray[iX][iY].img[iZ] = i2;
                        mapArray[iX][iY].img[iZ+1] = i1;
                    }
                }
                render(mapArray[iX][iY]);
                displaySelectedInfo(mapArray[sX][sY]);
            }

            function export2txt() {
                const a = document.createElement("a");
                a.href = URL.createObjectURL(new Blob([JSON.stringify(map)], {
                    type: "text/plain"
                }));
                a.setAttribute("download", "data.txt");
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
            }
            var fileList = null;

            function fileSelected(event) {
                fileList = event.target.files;
                if (fileList == null) {
                    alert("Select file to load first!")
                } else {
                    const reader = new FileReader();
                    reader.addEventListener('load', (event) => {
                        let text = event.target.result;
                        loadMap(JSON.parse(text));
                        render();
                    });
                    reader.readAsText(fileList[0]);
                }
            }

            function selectedWidthChanged(){
                document.getElementById("mapCanvas").width = 70* parseInt(document.getElementById("inputGroupSelectWidth").value)
                render();
            }
            function selectedHeightChanged(){
                document.getElementById("mapCanvas").height = 70* parseInt(document.getElementById("inputGroupSelectHeight").value)
                render();
            }
        </script>
    </head>

    <body onload="setup()">
        <div class="container" style="max-width: 100%; max-height: 90%;">
            <div class="row">
                <div class="col-2">
                    <ul class="nav nav-tabs" id="myTab" role="tablist">
                        <li class="nav-item">
                            <a class="nav-link active" id="home-tab" data-toggle="tab" href="#home" role="tab" aria-controls="home" aria-selected="true">
                                <svg class="bi bi-house-door" width="1em" height="1em" viewBox="0 0 16 16" fill="currentColor" xmlns="http://www.w3.org/2000/svg" title="Home">
                                    <path fill-rule="evenodd" d="M7.646 1.146a.5.5 0 01.708 0l6 6a.5.5 0 01.146.354v7a.5.5 0 01-.5.5H9.5a.5.5 0 01-.5-.5v-4H7v4a.5.5 0 01-.5.5H2a.5.5 0 01-.5-.5v-7a.5.5 0 01.146-.354l6-6zM2.5 7.707V14H6v-4a.5.5 0 01.5-.5h3a.5.5 0 01.5.5v4h3.5V7.707L8 2.207l-5.5 5.5z" clip-rule="evenodd"/>
                                    <path fill-rule="evenodd" d="M13 2.5V6l-2-2V2.5a.5.5 0 01.5-.5h1a.5.5 0 01.5.5z" clip-rule="evenodd"/>
                                  </svg>
                            </a>
                        </li>
                    </ul>
                    <div class="tab-content" id="myTabContent">
                        <div class="tab-pane fade show active" id="home" role="tabpanel" aria-labelledby="home-tab" style="height: 800px; overflow:scroll">
                            <form>
                                <div class="form-group">
                                    <button class="btn btn-primary" onclick="sX=null;sY=null;render()">Update Display</button>
                                </div>
                                <div class="form-group">
                                    <input type="checkbox" id="showXY" onchange="render()" />
                                    <label for="showXY"> Show Corrdinates</label><br/>
                                    <input type="checkbox" id="showGrid" checked="true" onchange="render()" />
                                    <label for="showGrid"> Show Grid</label><br/>
                                    <input type="checkbox" id="showRedGrid" onchange="render()" />
                                    <label for="showRedGrid"> Red Grid</label>
                                </div>
                                <div class="form-group">
                                    <button class="btn btn-primary" onclick="export2txt()">Save Map</button>
                                </div>
                                <div class="form-group">
                                    <div class="custom-file">
                                        <input type="file" class="custom-file-input" id="customFile" onchange="fileSelected(event)">
                                        <label class="custom-file-label" for="customFile">Load Map..</label>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <div id="selectedCoordsDiv"></div>
                                    <div id="selectedImgDiv"></div>
                                </div>
                                <div class="form-group">                                
                                    <div class="input-group mb-3">
                                        <div class="input-group-prepend">
                                            <label class="input-group-text" for="inputGroupSelectWidth">Width</label>
                                        </div>
                                        <select class="custom-select" id="inputGroupSelectWidth"  onchange="selectedWidthChanged()">
                                            <option  value="1"> 1</option><option  value="2"> 2</option><option  value="3"> 3</option><option  value="4"> 4</option><option  value="5"> 5</option>
                                            <option  value="6"> 6</option><option  value="7"> 7</option><option  value="8"> 8</option><option  value="9"> 9</option><option value="10">10</option>
                                            <option value="11">11</option><option value="12">12</option><option value="13">13</option><option value="14">14</option><option value="15">15</option>
                                            <option value="16">16</option><option value="17">17</option><option value="18">18</option><option value="19">19</option><option value="20">20</option>
                                            <option value="21">21</option><option value="22">22</option><option value="23">23</option><option value="24">24</option><option value="25">25</option>
                                            <option value="26">26</option><option value="27">27</option><option value="28">28</option><option value="29">29</option><option value="30">30</option>
                                            <option value="31">31</option><option value="32">32</option><option value="33">33</option><option value="34">34</option><option value="35">35</option>
                                            <option value="36">36</option><option value="37">37</option><option value="38">38</option><option value="39">39</option><option value="40">40</option>
                                            <option value="41">41</option><option value="42">42</option><option value="43">43</option><option value="44">44</option><option value="45">45</option>
                                            <option value="46">46</option><option value="47">47</option><option value="48">48</option><option value="49">49</option><option selected value="50">50</option>
                                            <option value="51">51</option><option value="52">52</option><option value="53">53</option><option value="54">54</option><option value="55">55</option>
                                            <option value="56">56</option><option value="57">57</option><option value="58">58</option><option value="59">59</option><option value="60">60</option>
                                            <option value="61">61</option><option value="62">62</option><option value="63">63</option><option value="64">64</option><option value="65">65</option>
                                            <option value="66">66</option><option value="67">67</option><option value="68">68</option><option value="69">69</option><option value="70">70</option>
                                            <option value="71">71</option><option value="72">72</option><option value="73">73</option><option value="74">74</option><option value="75">75</option>
                                            <option value="76">76</option><option value="77">77</option><option value="78">78</option><option value="79">79</option><option value="80">80</option>
                                            <option value="81">81</option><option value="82">82</option><option value="83">83</option><option value="84">84</option><option value="85">85</option>
                                            <option value="86">86</option><option value="87">87</option><option value="88">88</option><option value="89">89</option><option value="90">90</option>
                                            <option value="91">91</option><option value="92">92</option><option value="93">93</option><option value="94">94</option><option value="95">95</option>
                                            <option value="96">96</option><option value="97">97</option><option value="98">98</option><option value="99">99</option><option value="100">100</option>
                                        </select>
                                    </div>
                                    <div class="input-group mb-3">
                                        <div class="input-group-prepend">
                                            <label class="input-group-text" for="inputGroupSelectHeight">Height</label>
                                        </div>
                                        <select class="custom-select" id="inputGroupSelectHeight" onchange="selectedHeightChanged()">
                                            <option  value="1"> 1</option><option  value="2"> 2</option><option  value="3"> 3</option><option  value="4"> 4</option><option  value="5"> 5</option>
                                            <option  value="6"> 6</option><option  value="7"> 7</option><option  value="8"> 8</option><option  value="9"> 9</option><option value="10">10</option>
                                            <option value="11">11</option><option value="12">12</option><option value="13">13</option><option value="14">14</option><option value="15">15</option>
                                            <option value="16">16</option><option value="17">17</option><option value="18">18</option><option value="19">19</option><option value="20">20</option>
                                            <option value="21">21</option><option value="22">22</option><option value="23">23</option><option value="24">24</option><option value="25">25</option>
                                            <option value="26">26</option><option value="27">27</option><option value="28">28</option><option value="29">29</option><option value="30">30</option>
                                            <option value="31">31</option><option value="32">32</option><option value="33">33</option><option value="34">34</option><option value="35">35</option>
                                            <option value="36">36</option><option value="37">37</option><option value="38">38</option><option value="39">39</option><option value="40">40</option>
                                            <option value="41">41</option><option value="42">42</option><option value="43">43</option><option value="44">44</option><option value="45">45</option>
                                            <option value="46">46</option><option value="47">47</option><option value="48">48</option><option value="49">49</option><option selected value="50">50</option>
                                            <option value="51">51</option><option value="52">52</option><option value="53">53</option><option value="54">54</option><option value="55">55</option>
                                            <option value="56">56</option><option value="57">57</option><option value="58">58</option><option value="59">59</option><option value="60">60</option>
                                            <option value="61">61</option><option value="62">62</option><option value="63">63</option><option value="64">64</option><option value="65">65</option>
                                            <option value="66">66</option><option value="67">67</option><option value="68">68</option><option value="69">69</option><option value="70">70</option>
                                            <option value="71">71</option><option value="72">72</option><option value="73">73</option><option value="74">74</option><option value="75">75</option>
                                            <option value="76">76</option><option value="77">77</option><option value="78">78</option><option value="79">79</option><option value="80">80</option>
                                            <option value="81">81</option><option value="82">82</option><option value="83">83</option><option value="84">84</option><option value="85">85</option>
                                            <option value="86">86</option><option value="87">87</option><option value="88">88</option><option value="89">89</option><option value="90">90</option>
                                            <option value="91">91</option><option value="92">92</option><option value="93">93</option><option value="94">94</option><option value="95">95</option>
                                            <option value="96">96</option><option value="97">97</option><option value="98">98</option><option value="99">99</option><option value="100">100</option>
                                        </select>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                <div class="col-10" style="height: 900; overflow:scroll">
                    <canvas id="mapCanvas" width="3500" height="3500" style="border: 1px solid #000000;" onclick="canvasClick(event)"></canvas>
                </div>
            </div>
        </div>
    </body>
</html>